<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENERADOR RECIBOS DE PAGO</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable plugin for creating tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; text-align: center; }
        .tab-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">GENERADOR DE RECIBOS DE PAGO</h1>
        </header>

        <!-- Global Settings -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Fecha de pago</h2>
            <div class="max-w-xs mx-auto">
                
                <input type="date" id="payDate" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-8 flex justify-center border-b border-gray-200">
            <button onclick="switchTab('A')" id="tab-btn-A" class="tab-btn active text-lg font-semibold py-3 px-8 border-b-4 transition-colors duration-300">Corazones</button>
            <button onclick="switchTab('B')" id="tab-btn-B" class="tab-btn text-lg font-semibold py-3 px-8 border-b-4 border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300 transition-colors duration-300">Hojas</button>
        </div>

        <!-- Tab Content A (Team Alpha) -->
        <div id="tab-content-A" class="tab-content active">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Corazones</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <div class="md:col-span-3">
                        <label for="employeeNameA" class="block text-sm font-medium text-gray-700 mb-1">Nombre del nuevo empleado</label>
                        <div class="flex space-x-3">
                            <input type="text" id="employeeNameA" placeholder="Agregar al grupo de corazones" class="flex-grow w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                            <button onclick="addEmployee('A')" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700">Agregar</button>
                        </div>
                    </div>
                    <div class="md:col-span-3 mt-4 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pago x pieza</label>
                        <div id="global-rates-A" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>
            <div id="employee-list-A" class="space-y-8"></div>
        </div>

        <!-- Tab Content B (Team Bravo) -->
        <div id="tab-content-B" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                 <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Hojas</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <div class="md:col-span-3">
                        <label for="employeeNameB" class="block text-sm font-medium text-gray-700 mb-1">Nombre del nuevo empleado</label>
                        <div class="flex space-x-3">
                            <input type="text" id="employeeNameB" placeholder="Agregar al grupo de hojas" class="flex-grow w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                            <button onclick="addEmployee('B')" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700">Agregar</button>
                        </div>
                    </div>
                    <div class="md:col-span-3 mt-4 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pago por kg</label>
                        <div id="global-rates-B" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </div>
            <div id="employee-list-B" class="space-y-8"></div>
        </div>
        
        <footer class="mt-12 text-center">
            <button onclick="generatePDF()" class="bg-green-600 text-white font-bold px-10 py-4 rounded-lg shadow-xl hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 text-lg">
                GENERAR RECIBOS
            </button>
        </footer>

        <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
            <p id="toast-message"></p>
        </div>
    </div>

    <script>
        // --- DATA MANAGEMENT ---
        let activeTab = 'A';
        const days = ['Lunes', 'Martes', 'Miercoels', 'Jueves', 'Viernes', 'Sábado'];

        const itemNamesA = ['Chico', 'Mediano', 'Grande', 'Mini'];
        let itemRatesA = [10, 12, 14, 10];
        let employeesA = [
            { id: 1, name: 'Ana Hernandez', production: [[10,12,15,11,13,8], [5,6,4,7,8,5], [20,22,21,23,19,10], [3,4,2,5,4,3]] },
            { id: 2, name: 'Maria Garcia', production: [[8,9,10,12,11,7], [7,8,6,9,10,6], [18,20,19,21,17,9], [4,5,3,6,5,4]] }
        ];

        const itemNamesB = ['Blanca', 'Capote', 'Tira'];
        let itemRatesB = [13, 8, 6];
        let employeesB = [
            { id: 3, name: 'Fernanda Rodriguez', production: [[5,6,7,5,8,4], [10,11,9,12,10,6], [15,14,16,13,17,10]] },
            { id: 4, name: 'Jimena Lopez', production: [[6,7,8,6,9,5], [11,12,10,13,11,7], [16,15,17,14,18,11]] }
        ];

        // --- CORE UI LOGIC ---

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-btn-${tabId}`).classList.add('active');
            document.getElementById(`tab-content-${tabId}`).classList.add('active');
        }

        // --- DATA UPDATERS ---

        function updateProduction(team, employeeId, itemIndex, dayIndex, value) {
            const employees = team === 'A' ? employeesA : employeesB;
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) employee.production[itemIndex][dayIndex] = parseInt(value, 10) || 0;
        }

        function updateRate(team, itemIndex, value) {
            if (team === 'A') itemRatesA[itemIndex] = parseFloat(value) || 0;
            else itemRatesB[itemIndex] = parseFloat(value) || 0;
        }

        function addEmployee(team) {
            const nameInput = document.getElementById(`employeeName${team}`);
            const name = nameInput.value.trim();
            if (!name) return showToast("Please enter an employee name.");

            const employees = team === 'A' ? employeesA : employeesB;
            const itemNames = team === 'A' ? itemNamesA : itemNamesB;
            
            employees.push({
                id: Date.now(),
                name: name,
                production: Array(itemNames.length).fill(0).map(() => Array(days.length).fill(0)),
            });

            renderEmployees(team);
            nameInput.value = '';
            nameInput.focus();
        }

        function deleteEmployee(team, employeeId) {
            if (team === 'A') employeesA = employeesA.filter(emp => emp.id !== employeeId);
            else employeesB = employeesB.filter(emp => emp.id !== employeeId);
            renderEmployees(team);
        }

        // --- RENDERING ---

        function renderAll() {
            renderGlobalRates('A');
            renderEmployees('A');
            renderGlobalRates('B');
            renderEmployees('B');
        }

        function renderGlobalRates(team) {
            const ratesDiv = document.getElementById(`global-rates-${team}`);
            const itemRates = team === 'A' ? itemRatesA : itemRatesB;
            const itemNames = team === 'A' ? itemNamesA : itemNamesB;
            
            ratesDiv.innerHTML = itemNames.map((name, i) => `
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">${name}</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                        <input type="number" min="0" step="0.01" value="${itemRates[i]}" oninput="updateRate('${team}', ${i}, this.value)" class="w-full pl-7 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            `).join('');
        }

        function renderEmployees(team) {
            const employeeListDiv = document.getElementById(`employee-list-${team}`);
            const employees = team === 'A' ? employeesA : employeesB;
            
            if (employees.length === 0) {
                employeeListDiv.innerHTML = `<div class="text-center py-12 bg-white rounded-2xl shadow-lg"><h3 class="text-xl font-medium text-gray-500">No employees added to this team.</h3></div>`;
                return;
            }

            employeeListDiv.innerHTML = employees.map(emp => createEmployeeCardHTML(emp, team)).join('');
        }
        
        function createEmployeeCardHTML(employee, team) {
            const itemNames = team === 'A' ? itemNamesA : itemNamesB;
            
            let tableRows = itemNames.map((itemName, itemIndex) => {
                let dayInputs = days.map((day, dayIndex) => 
                    `<td class="p-1"><input type="number" min="0" value="${employee.production[itemIndex][dayIndex]}" oninput="updateProduction('${team}', ${employee.id}, ${itemIndex}, ${dayIndex}, this.value)" class="w-20 p-2 border border-gray-200 rounded-md focus:ring-1 focus:ring-blue-500"></td>`
                ).join('');
                return `<tr class="border-b"><td class="font-semibold py-2 px-3 text-gray-700">${itemName}</td>${dayInputs}</tr>`;
            }).join('');
            
            let tableHeaders = days.map(day => `<th class="py-2 px-1 font-medium text-gray-500 text-sm">${day.substring(0,3)}</th>`).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${employee.name}</h3>
                        <button onclick="deleteEmployee('${team}', ${employee.id})" class="text-red-500 hover:text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-100 transition">Eliminar</button>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2 text-gray-600">Producción Semanal</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-center">
                                <thead><tr class="border-b-2"><th class="py-2 px-3 text-left font-medium text-gray-500 text-sm">Tipo</th>${tableHeaders}</tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }
        
        // --- PDF GENERATION ---
        
        function generatePDF() {
            const payDate = document.getElementById('payDate').value;
            if (!payDate) return showToast("Please select a pay date.");
            if (employeesA.length === 0 && employeesB.length === 0) return showToast("Add at least one employee to generate a report.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const formattedPayDate = new Date(payDate + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\//g, '-');
            
            let currentY = 15; // Initial Y position
            const pageHeight = doc.internal.pageSize.getHeight();
            const bottomMargin = 20;

            const processTeam = (teamName, employees, itemNames, itemRates) => {
                employees.forEach(employee => {
                    // Estimate height of the next paystub (header + table + footer + padding)
                    // A rough estimate: 25mm for header/footer + (rows * 6mm) for table
                    const estimatedHeight = 35 + (itemNames.length * 6);

                    // Check if there is enough space, if not, add a new page
                    if (currentY + estimatedHeight > pageHeight - bottomMargin) {
                        doc.addPage();
                        currentY = 15; // Reset Y for new page
                    }
                    
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text("Recibo de pago", 14, currentY);
                    
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Grupo: ${teamName}`, 200, currentY, { align: 'right' });
                    currentY += 7;

                    doc.setFontSize(12);
                    doc.text(`${employee.name}`, 14, currentY);
                    doc.text(`Fecha: ${formattedPayDate}`, 200, currentY, { align: 'right' });
                    currentY += 2;

                    const tableHead = [['Tipo', ...days, 'Cantidad', (teamName == "Corazones")?'Pago x pza':'Pago x kg', 'Subtotal']];
                    let totalWeeklyPay = 0;
                    
                    const tableBody = employee.production.map((itemProd, itemIdx) => {
                        const totalUnits = itemProd.reduce((sum, count) => sum + count, 0);
                        const rate = itemRates[itemIdx];
                        const subtotal = totalUnits * rate;
                        totalWeeklyPay += subtotal;
                        return [itemNames[itemIdx], ...itemProd, totalUnits, `$${rate.toFixed(2)}`, `$${subtotal.toFixed(2)}`];
                    });

                    doc.autoTable({
                        head: tableHead, body: tableBody, startY: currentY, theme: 'grid',
                        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                        styles: { fontSize: 9, cellPadding: 2.5 },
                        columnStyles: { 0: { fontStyle: 'bold' }, 7: { halign: 'right' }, 8: { halign: 'right' }, 9: { halign: 'right', fontStyle: 'bold' } }
                    });

                    const finalY = doc.autoTable.previous.finalY;
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Pago Total de la Semana: $${totalWeeklyPay.toFixed(2)}`, 14, finalY + 12);
                    
                    // Update currentY for the next paystub, adding a margin
                    currentY = finalY + 25;
                });
            };

            processTeam("Corazones", employeesA, itemNamesA, itemRatesA);
            processTeam("Hoja", employeesB, itemNamesB, itemRatesB);
            
            doc.save(`paystubs_all_teams_${formattedPayDate.replace(/-/g, '_')}.pdf`);
        }
        
        // --- UTILITY ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.querySelector('p').textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            document.getElementById('payDate').value = new Date().toISOString().split('T')[0];
            renderAll();
            switchTab('A');
        };
    </script>
</body>
</html>

